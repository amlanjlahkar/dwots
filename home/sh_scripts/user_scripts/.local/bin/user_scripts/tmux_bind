#!/usr/bin/env bash

# Interactive creation of tmux sessions
# dependencies: rofi

rofi() { command rofi -dmenu -p "$@"; }
tmuxs() { $TERMINAL -e env TERM=screen-256color tmux $*; }

if [ -z "$(pgrep tmux)" ]; then
  session_name="$(rofi 'Session Name(default is id): ')"
  tmuxs new -s "$session_name"
  exit
fi

declare -A sessions=()
for name in $(tmux ls -F "#{session_name}"); do
  sessions["$name"]="$name"
done

if [ "${#sessions[@]}" -eq 1 ]; then
  tmuxs attach-session -t "${sessions[$name]}"
  exit
fi

session_name="$(printf '%s\n' "${sessions[@]}" | rofi 'Choose session:')"
[ -z "$session_name" ] && exit

if [[ -v sessions["$session_name"] ]]; then
  tmuxs attach-session -t "$session_name"
else
  chosen="$(printf '%s\n%s' "Yes" "No" | rofi "Session doesn't exist. Create session?")"
  [ "$chosen" = 'Yes' ] && tmuxs new -s "$session_name" || exit
fi
